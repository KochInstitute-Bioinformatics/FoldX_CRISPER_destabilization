// Default configuration
conda {
    enabled = true
    channels = ['conda-forge', 'bioconda', 'defaults']
}

params {
    // Input parameters
    mutation_csv = null
    foldx_path = "foldx_20251231"  // Updated to correct executable name
    structure_dir = "./structures"
    outdir = "results"
    
    // FoldX parameters
    chain = 'A'
    number_of_runs = 1
    
    // Help message
    help = false
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Process configuration
process {
    withName: 'PARSE_FXOUT' {
        container = "docker://jupyter/scipy-notebook:latest"
    }
    withName: 'GENERATE_MUTATION_FILES' {
        container = "docker://jupyter/scipy-notebook:latest"
    }
    withName: 'CALCULATE_DDG' {
        container = "docker://jupyter/scipy-notebook:latest"
    }
    withName: 'REPAIR_STRUCTURES' {
        container = "docker://bumproo/foldx5"
    }
    withName: 'RUN_BUILDMODEL' {
        container = "docker://bumproo/foldx5"
    }
}

// Cluster-specific profiles
profiles {
    // Profile for Singularity clusters
    singularity {
        singularity {
            enabled = true
            autoMounts = true
            runOptions = '--cleanenv --containall'
        }
    }
    
    // Profile for Apptainer clusters
    apptainer {
        apptainer {
            enabled = true
            autoMounts = true
            runOptions = '--cleanenv --containall'
        }
    }
    
    // Profile for Docker clusters (if available)
    docker {
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
        }
    }
    
    // Fallback profile using only Conda
    conda_only {
        // No container runtime - uses only conda
        process {
            withName: 'PARSE_FXOUT' {
                conda = "conda-forge::pandas=2.0.3"
            }
            withName: 'GENERATE_MUTATION_FILES' {
                conda = "conda-forge::pandas=2.0.3"
            }
            withName: 'CALCULATE_DDG' {
                conda = "conda-forge::pandas=2.0.3"
            }
            withName: 'REPAIR_STRUCTURES' {
                conda = "conda-forge::python=3.11"
            }
            withName: 'RUN_BUILDMODEL' {
                conda = "conda-forge::python=3.11"
            }
        }
    }
}

// Capture Nextflow log files
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}
dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}